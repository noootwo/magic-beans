# Magic Beans App - 图片导入与编辑 PRD

## 1. 产品概述
为 Magic Beans 编辑器增加“图片导入与编辑”能力，让用户一键将本地图片转换为珠子网格，并提供常用编辑工具与导出功能，实现从灵感图案到手工图纸的完整闭环。

## 2. 用户故事
| 角色 | 故事 | 验收要点 |
|------|------|----------|
| 普通用户 | 我可以从本地选择一张图片并快速看到转换后的网格 | 支持 PNG/JPG；默认 32×32；3 秒内完成转换；转换结果即时渲染 |
| 进阶用户 | 我可以调整转换参数并实时预览效果 | 支持尺寸 16/32/64、调色盘 16/32 色、抖动开关、亮度/对比度滑条；参数变更后 1 秒内刷新预览 |
| 所有用户 | 我可以使用常见工具对网格进行修改 | 画笔/橡皮擦/取色器/填充/矩形选区；支持快捷键；操作响应 ≤ 100 ms |
| 所有用户 | 我可以撤销/重做任意步骤 | 历史栈 ≥ 100 步；快捷键 ⌘Z / ⌘⇧Z；无 UI 阻塞 |
| 所有用户 | 我可以导出 PNG 或保存工程 JSON | PNG 含/不含网格可选；JSON 可在重载后完整恢复；导出耗时 ≤ 2 秒 |

## 3. 功能模块
### 3.1 导入与转换
- **入口**：顶部工具栏“导入图片”按钮；支持拖拽文件到画布或页面空白处（后续增强）。
- **文件限制**：≤ 5 MB；仅 PNG/JPG；分辨率 ≥ 64×64 且 ≤ 4096×4096；超限友好提示。
- **转换参数面板**（右侧）：
  - 目标网格尺寸：16×16 / 32×32 / 64×64（默认 32×32）
  - 调色盘：内置 16 色 / 32 色 / 自定义（上传调色盘 JSON）
  - 抖动：关闭 / Floyd-Steinberg 误差扩散
  - 亮度：-50 ~ +50（滑条，默认 0）
  - 对比度：-50 ~ +50（滑条，默认 0）
  - 缩放策略：Cover（填满裁剪）/ Contain（居中留白）
- **实时预览**：参数变更后 1 秒内刷新画布；支持“应用”与“重置”按钮。

### 3.2 编辑工具
- **工具栏**（左侧纵向）：
  - 画笔（B）：尺寸 1/3/5；颜色取自当前调色盘高亮色
  - 橡皮擦（E）：尺寸同画笔；清除为透明
  - 取色器（I）：点击网格单元吸取颜色并切换调色盘高亮
  - 填充（F）：同色区域泛洪填充
  - 矩形选区（R）：拖拽选择后支持移动/删除/填充
- **交互增强**：
  - 网格吸附：指针自动对齐最近网格中心
  - 撤销/重做：历史栈容量 100；内存占用平稳；支持键盘快捷键
  - 缩放/平移：与现有百分比同步；滚轮缩放以指针为中心；工具状态不丢失

### 3.3 导出与持久化
- **导出面板**（右侧下方）：
  - PNG：分辨率 = 网格尺寸 × 珠子像素（16×16 px）；可选叠加网格线；文件名模板 `{project}_{size}.png`
  - JSON：包含 grid、palette、size、version；用于本地存档与下次打开
- **自动保存**：每 30 秒或切换工具时写入 IndexedDB；异常恢复提示“恢复未保存更改”

## 4. 非功能需求
- **性能**：32×32 网格交互保持 60 FPS；64×64 在低端笔记本 ≥ 45 FPS；内存峰值 ≤ 100 MB（不含原图）
- **可访问性**：工具按钮 aria-label；对比度 ≥ 4.5；键盘全可访问
- **错误处理**：导入失败、文件损坏、超限均弹 Toast；提供“重试”或“选择其他文件”
- **兼容性**：Chrome/Edge/Firefox/Safari 近两年版本；移动端 375×812 可用（侧边栏折叠）

## 5. 验收标准（摘要）
1. 本地 PNG/JPG 导入成功率 ≥ 99 %，转换结果与预览一致
2. 所有工具在 32×32 与 64×64 网格下操作无卡顿，历史栈正确
3. 导出 PNG 与 JSON 文件可正常打开，JSON 重载后 100 % 还原
4. 通过自动化测试：核心算法 ≥ 90 % 覆盖；UI 集成关键路径全覆盖；lint/type-check 零错误
5. 手动验收：桌面 1920×1080 与移动 375×812；对比度与可读性通过；拖拽导入与键盘快捷键可用

## 6. 后续迭代（超出本阶段）
- 调色盘自定义上传、云端共享
- 更多抖动算法（Bayer、Atkinson）
- 动画帧时间轴、逐帧导出 GIF
- 云同步与多人协作